# Tên của quy trình CI/CD
name: CI/CD Docker Portfolio

# Kích hoạt khi: push lên nhánh 'main'
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # Job 1: Build và đẩy image lên Docker Hub
  build-and-push:
    runs-on: ubuntu-latest # Chạy trên máy ảo Ubuntu
    steps:
      # Lấy code từ repo về máy ảo
      - name: Checkout code
        uses: actions/checkout@v3

      # Đăng nhập vào Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      # Build và Push image
      # Thay 'ten-dockerhub-cua-ban/my-portfolio'
      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: . # Lấy 'Dockerfile' từ thư mục gốc
          file: ./Dockerfile # Đường dẫn tới Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/my-portfolio:latest

  # Job 2: Deploy image lên máy chủ VPS
  deploy:
    # Chạy sau khi 'build-and-push' hoàn thành
    needs: build-and-push 
    runs-on: ubuntu-latest

    # Chỉ chạy job 'deploy' nếu sự kiện là 'push' vào nhánh 'main'
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to Server
        # Sử dụng action SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            # Đảm bảo pull image mới nhất
            docker pull ${{ secrets.DOCKER_USERNAME }}/my-portfolio:latest
            
            # Dừng và xóa container cũ (nếu đang chạy)
            # '|| true' để lệnh không bị lỗi nếu container chưa tồn tại
            docker stop my-portfolio-app || true
            docker rm my-portfolio-app || true
            
            # Chạy container mới
            docker run -d -p 80:80 --name my-portfolio-app ${{ secrets.DOCKER_USERNAME }}/my-portfolio:latest